- name: install windows adk
  win_package:
    path: "{{ win_adk_download_url }}"
    product_id: '{C4443D4E-AC00-CF0E-9519-C9111E83ADBB}'
    arguments: /quiet /installpath c:\ADK /features OptionId.DeploymentTools OptionId.WindowsPreinstallationEnvironment

- name: create a working copy of the windows pe files
  win_shell: '"..\\Deployment Tools\\DandISetEnv.bat" & copype amd64 C:\WinPE_amd64_PS'
  args:
    executable: cmd
    chdir: C:\ADK\Assessment and Deployment Kit\Windows Preinstallation Environment
    creates: C:\WinPE_amd64_PS

#- name: mount windows pe image
#  win_shell: Dism /Mount-Image /ImageFile:"C:\WinPE_amd64_PS\media\sources\boot.wim" /Index:1 /MountDir:"C:\WinPE_amd64_PS\mount"
#  args:
#    executable: cmd
#    chdir: C:\ADK\Assessment and Deployment Kit\Windows Preinstallation Environment
#    creates: C:\WinPE_amd64_PS\mount\Windows
#
#- name: add packages
#  win_shell: Dism /Add-Package /Image:"C:\WinPE_amd64_PS\mount" /PackagePath:"c:\ADK\Assessment and Deployment Kit\Windows Preinstallation Environment\amd64\WinPE_OCs\{{ item }}"
#  args:
#    executable: cmd
#    chdir: C:\ADK\Assessment and Deployment Kit\Windows Preinstallation Environment
#  with_items:
#    - WinPE-WMI.cab
#    - en-us\WinPE-WMI_en-us.cab
#    - WinPE-NetFX.cab
#    - en-us\WinPE-NetFX_en-us.cab
#    - WinPE-Scripting.cab
#    - en-us\WinPE-Scripting_en-us.cab
#    - WinPE-PowerShell.cab
#    - en-us\WinPE-PowerShell_en-us.cab
#    - WinPE-StorageWMI.cab
#    - en-us\WinPE-StorageWMI_en-us.cab
#    - WinPE-DismCmdlets.cab
#    - en-us\WinPE-DismCmdlets_en-us.cab
#

- name: copy winpeshl.ini file
  win_copy:
    src: winpeshl.ini
    dest: C:\WinPE_amd64_PS\mount\Windows\system32\winpeshl.ini

- name: unmount windows pe image
  win_shell: Dism /Unmount-Image /MountDir:C:\WinPE_amd64_PS\mount /Commit
  args:
    executable: cmd
    chdir: C:\ADK\Assessment and Deployment Kit\Windows Preinstallation Environment
    removes: C:\WinPE_amd64_PS\mount\Windows

- name: copy script file
  win_copy:
    src: create_winpe.ps1
    dest: "{{ temp_directory }}\\create_winpe.ps1"

- name: load powershell modules into winpe
  win_shell: "{{ temp_directory }}\\create_winpe.ps1"

- name: create winpe iso file
  win_shell: '"..\\Deployment Tools\\DandISetEnv.bat" & MakeWinPEMedia /ISO C:\WinPE_amd64_PS {{ temp_directory }}\winpe_amd64_ps.iso'
  args:
    executable: cmd
    chdir: C:\ADK\Assessment and Deployment Kit\Windows Preinstallation Environment
    creates: "{{ temp_directory }}\\winpe_amd64_ps.iso"

- name: copy iso file
  win_copy:
    src: "{{ temp_directory }}\\winpe_amd64_ps.iso"
    dest: "{{ smb_share }}\\{{ destination_file_location }}\\"
    remote_src: yes
  become: yes
  become_method: runas
  become_flags: logon_type=new_credentials logon_flags=netcredentials_only
  vars:
    ansible_become_user: "{{ smb_share_username }}"
    ansible_become_pass: "{{ smb_share_password }}"
